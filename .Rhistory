.groups = "drop"
)
# Plot predicted probabilities over time
ggplot(newdat, aes(x = time_c_scaled, y = pred, color = as.factor(id))) +
geom_line(size = 1.2) +        # line for each subject
geom_point(size = 2) +         # points at each time
labs(
x = "Time (scaled)",
y = "Predicted Probability of Remission",
color = "Subject ID",
title = "Subject-Specific Predicted Trajectories"
) +
theme_minimal(base_size = 14) +
theme(
legend.position = "right",
plot.title = element_text(hjust = 0.5)
)
View(avg_pred)
View(mean_remission)
#| label: glmm-marginalize
# Extract variance-covariance matrix D
# This captures the population heterogeneity in random intercepts and slopes
D_matrix <-  as.matrix(VarCorr(glmm_rs_scaled)$id)
# Draw random effects
# Hint: MASS::mvrnorm(n = 5000, mu = c(0, 0), Sigma = D_matrix)
# Each row is a "hypothetical person" from the population
# Compute marginal probabilities by simulation
# For each arm at visit 5:
#   1. Calculate fixed effect: X'β (use fixef(glmm_rs))
#   2. For each random effect draw: add b_0 + b_1 * time_c
#   3. Apply inverse logit: plogis()
#   4. Average across all draws
# This averages over population heterogeneity → marginal effect
D_matrix
random_effects_draws <- MASS::mvrnorm(
n = 5000,
mu = c(0, 0), # Mean is c(0, 0) for random effects
Sigma = D_matrix
)
View(random_effects_draws)
D_matrix
D_matrix <-  as.matrix(VarCorr(glmm_rs)$id)
#D_matrix
# Draw random effects
# Hint: MASS::mvrnorm(n = 5000, mu = c(0, 0), Sigma = D_matrix)
# Each row is a "hypothetical person" from the population
random_effects_draws <- MASS::mvrnorm(
n = 5000,
mu = c(0, 0), # Mean is c(0, 0) for random effects
Sigma = D_matrix
)
D_matrix
fixed_effects <- fixef(glmm_rs)
View(long_dat)
View(long_dat)
#| label: glmm-marginalize
# Extract variance-covariance matrix D
# This captures the population heterogeneity in random intercepts and slopes
D_matrix <-  as.matrix(VarCorr(glmm_rs)$id)
D_matrix
# Draw random effects
# Hint: MASS::mvrnorm(n = 5000, mu = c(0, 0), Sigma = D_matrix)
# Each row is a "hypothetical person" from the population
random_effects_draws <- MASS::mvrnorm(
n = 5000,
mu = c(0, 0), # Mean is c(0, 0) for random effects
Sigma = D_matrix
)
# Compute marginal probabilities by simulation
# For each arm at visit 5:
#   1. Calculate fixed effect: X'β (use fixef(glmm_rs))
#   2. For each random effect draw: add b_0 + b_1 * time_c
#   3. Apply inverse logit: plogis()
#   4. Average across all draws
# This averages over population heterogeneity → marginal effect
# extract fixed effects
fixed_effects <- fixef(glmm_rs)
# 1. Arm = Control (Reference Arm)
X_arm_Control <- c(
`(Intercept)` = 1,
`time_c` = 2.5,
`armTx` = 0 # Reference category is 0
# Include any other fixed effect covariates set to their baseline/mean values
)
# 2. Arm = Tx (Treatment Arm)
X_arm_Tx <- c(
`(Intercept)` = 1,
`time_c` = 2.5,
`armTx` = 1 # Treatment category is 1
)
# --- Calculation for Arm = Control at Visit 5 ---
# 1. Calculate Fixed Effect Component (X'β)
# Note: This assumes fixed_effects is correctly ordered/named to match X_arm_Control
fixed_linear_predictor_Control <- sum(fixed_effects[names(X_arm_Control)] * X_arm_Control)
# 2. Add Random Effect Component (b_0 + b_1 * time_c)
# random_effects_draws[, 1] is b_0, random_effects_draws[, 2] is b_1
random_linear_predictor_Control <- random_effects_draws[, 1] + random_effects_draws[, 2] * time_c_v5
#| label: glmm-marginalize
# Extract variance-covariance matrix D
# This captures the population heterogeneity in random intercepts and slopes
D_matrix <-  as.matrix(VarCorr(glmm_rs)$id)
D_matrix
# Draw random effects
# Hint: MASS::mvrnorm(n = 5000, mu = c(0, 0), Sigma = D_matrix)
# Each row is a "hypothetical person" from the population
random_effects_draws <- MASS::mvrnorm(
n = 5000,
mu = c(0, 0), # Mean is c(0, 0) for random effects
Sigma = D_matrix
)
# Compute marginal probabilities by simulation
# For each arm at visit 5:
#   1. Calculate fixed effect: X'β (use fixef(glmm_rs))
#   2. For each random effect draw: add b_0 + b_1 * time_c
#   3. Apply inverse logit: plogis()
#   4. Average across all draws
# This averages over population heterogeneity → marginal effect
# extract fixed effects
fixed_effects <- fixef(glmm_rs)
# 1. Arm = Control (Reference Arm)
X_arm_Control <- c(
`(Intercept)` = 1,
`time_c` = 2.5,
`armTx` = 0 # Reference category is 0
# Include any other fixed effect covariates set to their baseline/mean values
)
# 2. Arm = Tx (Treatment Arm)
X_arm_Tx <- c(
`(Intercept)` = 1,
`time_c` = 2.5,
`armTx` = 1 # Treatment category is 1
)
# --- Calculation for Arm = Control at Visit 5 ---
# 1. Calculate Fixed Effect Component (X'β)
# Note: This assumes fixed_effects is correctly ordered/named to match X_arm_Control
fixed_linear_predictor_Control <- sum(fixed_effects[names(X_arm_Control)] * X_arm_Control)
# 2. Add Random Effect Component (b_0 + b_1 * time_c)
# random_effects_draws[, 1] is b_0, random_effects_draws[, 2] is b_1
random_linear_predictor_Control <- random_effects_draws[, 1] + random_effects_draws[, 2] * time_c_v5
#| label: glmm-marginalize
# Extract variance-covariance matrix D
# This captures the population heterogeneity in random intercepts and slopes
D_matrix <-  as.matrix(VarCorr(glmm_rs)$id)
D_matrix
# Draw random effects
# Hint: MASS::mvrnorm(n = 5000, mu = c(0, 0), Sigma = D_matrix)
# Each row is a "hypothetical person" from the population
random_effects_draws <- MASS::mvrnorm(
n = 5000,
mu = c(0, 0), # Mean is c(0, 0) for random effects
Sigma = D_matrix
)
# Compute marginal probabilities by simulation
# For each arm at visit 5:
#   1. Calculate fixed effect: X'β (use fixef(glmm_rs))
#   2. For each random effect draw: add b_0 + b_1 * time_c
#   3. Apply inverse logit: plogis()
#   4. Average across all draws
# This averages over population heterogeneity → marginal effect
# extract fixed effects
fixed_effects <- fixef(glmm_rs)
# 1. Arm = Control (Reference Arm)
X_arm_Control <- c(
`(Intercept)` = 1,
`time_c` = 2.5,
`armTx` = 0 # Reference category is 0
# Include any other fixed effect covariates set to their baseline/mean values
)
# 2. Arm = Tx (Treatment Arm)
X_arm_Tx <- c(
`(Intercept)` = 1,
`time_c` = 2.5,
`armTx` = 1 # Treatment category is 1
)
# --- Calculation for Arm = Control at Visit 5 ---
# 1. Calculate Fixed Effect Component (X'β)
# Note: This assumes fixed_effects is correctly ordered/named to match X_arm_Control
fixed_linear_predictor_Control <- sum(fixed_effects[names(X_arm_Control)] * X_arm_Control)
# 2. Add Random Effect Component (b_0 + b_1 * time_c)
# random_effects_draws[, 1] is b_0, random_effects_draws[, 2] is b_1
random_linear_predictor_Control <- random_effects_draws[, 1] + random_effects_draws[, 2] * 2.5
# Total Linear Predictor (for 5000 hypothetical people)
total_linear_predictor_Control <- fixed_linear_predictor_Control + random_linear_predictor_Control
# 3. Apply Inverse Logit (plogis)
prob_draws_Control <- plogis(total_linear_predictor_Control)
# 4. Average Across All Draws → Marginal Probability
marginal_prob_Control <- mean(prob_draws_Control)
# --- Calculation for Arm = Tx at Visit 5 ---
# 1. Calculate Fixed Effect Component (X'β)
fixed_linear_predictor_Tx <- sum(fixed_effects[names(X_arm_Tx)] * X_arm_Tx)
# 2. Add Random Effect Component (b_0 + b_1 * time_c)
random_linear_predictor_Tx <- random_effects_draws[, 1] + random_effects_draws[, 2] * time_c_v5
#| label: glmm-marginalize
# Extract variance-covariance matrix D
# This captures the population heterogeneity in random intercepts and slopes
D_matrix <-  as.matrix(VarCorr(glmm_rs)$id)
D_matrix
# Draw random effects
# Hint: MASS::mvrnorm(n = 5000, mu = c(0, 0), Sigma = D_matrix)
# Each row is a "hypothetical person" from the population
random_effects_draws <- MASS::mvrnorm(
n = 5000,
mu = c(0, 0), # Mean is c(0, 0) for random effects
Sigma = D_matrix
)
# Compute marginal probabilities by simulation
# For each arm at visit 5:
#   1. Calculate fixed effect: X'β (use fixef(glmm_rs))
#   2. For each random effect draw: add b_0 + b_1 * time_c
#   3. Apply inverse logit: plogis()
#   4. Average across all draws
# This averages over population heterogeneity → marginal effect
# extract fixed effects
fixed_effects <- fixef(glmm_rs)
# 1. Arm = Control (Reference Arm)
X_arm_Control <- c(
`(Intercept)` = 1,
`time_c` = 2.5,
`armTx` = 0 # Reference category is 0
# Include any other fixed effect covariates set to their baseline/mean values
)
# 2. Arm = Tx (Treatment Arm)
X_arm_Tx <- c(
`(Intercept)` = 1,
`time_c` = 2.5,
`armTx` = 1 # Treatment category is 1
)
# --- Calculation for Arm = Control at Visit 5 ---
# 1. Calculate Fixed Effect Component (X'β)
# Note: This assumes fixed_effects is correctly ordered/named to match X_arm_Control
fixed_linear_predictor_Control <- sum(fixed_effects[names(X_arm_Control)] * X_arm_Control)
# 2. Add Random Effect Component (b_0 + b_1 * time_c)
# random_effects_draws[, 1] is b_0, random_effects_draws[, 2] is b_1
random_linear_predictor_Control <- random_effects_draws[, 1] + random_effects_draws[, 2] * 2.5
# Total Linear Predictor (for 5000 hypothetical people)
total_linear_predictor_Control <- fixed_linear_predictor_Control + random_linear_predictor_Control
# 3. Apply Inverse Logit (plogis)
prob_draws_Control <- plogis(total_linear_predictor_Control)
# 4. Average Across All Draws → Marginal Probability
marginal_prob_Control <- mean(prob_draws_Control)
# --- Calculation for Arm = Tx at Visit 5 ---
# 1. Calculate Fixed Effect Component (X'β)
fixed_linear_predictor_Tx <- sum(fixed_effects[names(X_arm_Tx)] * X_arm_Tx)
# 2. Add Random Effect Component (b_0 + b_1 * time_c)
random_linear_predictor_Tx <- random_effects_draws[, 1] + random_effects_draws[, 2] * 2.5
# Total Linear Predictor (for 5000 hypothetical people)
total_linear_predictor_Tx <- fixed_linear_predictor_Tx + random_linear_predictor_Tx
# 3. Apply Inverse Logit (plogis)
prob_draws_Tx <- plogis(total_linear_predictor_Tx)
# 4. Average Across All Draws → Marginal Probability
marginal_prob_Tx <- mean(prob_draws_Tx)
cat("Marginal Probability at Visit 5 (time_c =", 2.5, "):\n")
cat("Arm = Control (Reference):", round(marginal_prob_Control, 4), "\n")
cat("Arm = Tx (Treatment):", round(marginal_prob_Tx, 4), "\n")
View(corr_df)
#| label: setup
knitr::opts_chunk$set(echo = FALSE,
warning = FALSE,
message = FALSE)
# Load packages
suppressPackageStartupMessages({
library(haven) # for reading in data
library(tidyverse) # for manipulating data
library(gtsummary) # for making table 1
library(cards)
library(kableExtra)
library(huxtable) # for styling tables
library(gtreg) # for making tables
library(knitr) # for tidying output
library(ggplot2) # for plotting
library(geepack) # for fitting GEE models
library(emmeans) # for GLMM
library(lmerTest)
library(lme4)
library(broom.mixed)
library(patchwork)
})
# Read in data
cdystonia <- read_dta("Data/cdystonia.dta") # mapping to Data folder in GitHub repo
# Inspect data
#head(cdystonia)
cdystonia <- cdystonia %>% dplyr::mutate(
treat = dplyr::case_when(
treat == 1 ~ "10000 U",
treat == 2 ~ "5000 U",
treat == 3 ~ "Placebo"
),
treat = factor(treat, levels = c("Placebo", "5000 U", "10000 U")),
sex = dplyr::case_when(
sex == 1 ~ "Female",
sex == 2 ~ "Male")
,
sex = factor(sex, levels = c("Male", "Female")), # want male as reference group
site = factor(site, levels = c("1", "2", "3", "4", "5", "6", "7", "8", "9")))
# Filter to only week 0
cdystonia_wk0 <- cdystonia %>%
dplyr::filter(week == 0)
tbl <- cdystonia_wk0 |>
tbl_summary(by = treat,
include = c(sex, age,twstrs),
type=all_continuous()~"continuous2",
label = list(sex = "Sex",age~"Age (years)",twstrs="TWSTRS total score at baseline"),
statistic = list(
age ~ c(
"{N_obs}",
"{mean | style_number(digits = 1)} ({sd | style_number(digits = 1)})",
"{median}",
"{min}, {max}"),
all_categorical() ~ "{n} ({p}%)",
twstrs~"{mean} ({sd})")) |>
add_overall() |>
add_p(pvalue_fun = ~style_sigfig(., digits = 4)) |>
modify_footnote(
all_stat_cols() ~
"BotB = botulinum toxin type B; TWSTRS = Toronto Western Spasmodic Torticollis Rating Scale.",
abbreviation = FALSE
) |>
modify_spanning_header(c(stat_2,stat_3)~"**BotB**")
# Filter to only week 0
cdystonia_wk0 <- cdystonia %>%
dplyr::filter(week == 0)
tbl <- cdystonia_wk0 |>
tbl_summary(by = treat,
include = c(sex, age,twstrs),
digits=list(all_continuous()~c(1,1)),
type=all_continuous()~"continuous2",
label = list(sex = "Sex",age~"Age (years)",twstrs="TWSTRS total score at baseline"),
statistic = list(
age ~ c(
"{N_obs}",
"{mean} ({sd})",
"{median}",
"{min}, {max}"),
all_categorical() ~ "{n} ({p}%)",
twstrs~"{mean} ({sd})")) |>
add_overall() |>
add_p(pvalue_fun = ~style_sigfig(., digits = 4)) |>
modify_footnote(
all_stat_cols() ~
"BotB = botulinum toxin type B; TWSTRS = Toronto Western Spasmodic Torticollis Rating Scale.",
abbreviation = FALSE
) |>
modify_spanning_header(c(stat_2,stat_3)~"**BotB**")
tbl$table_body$label[tbl$table_body$label == "No. obs."] <- "N"
# making a wide dataset
cdystonia_wide <- cdystonia %>%
pivot_wider(
id_cols = c(id, treat, site, age, sex),
names_from = week,
values_from = twstrs,
names_prefix = "twstrs_"
)
ten_subjects_wide <- cdystonia_wide %>%
head(10)
tbl2 <-
ten_subjects_wide %>%
dplyr::select(id, treat, age, sex, twstrs_2, twstrs_4, twstrs_8, twstrs_12, twstrs_16) %>%
# 1. Create the gtsummary listing object
tbl_listing() %>%
# 2. Modify the column headers using modify_header()
modify_header(
id = "**ID**",
trt = "**Group**",
age = "**Age**",
sexc = "**Sex**",
twstrs_2 = "**Week 2**",
twstrs_4 = "**Week 4**",
twstrs_8 = "**Week 8**",
twstrs_12 = "**Week 12**",
twstrs_16 = "**Week 16**"
) %>%
as_kable_extra(
booktabs = TRUE,
longtable = TRUE,
linesep = "",
caption = "TWSTRS scores for 109 patients with CD at weeks 2, 4, 8, 12, 16"
)
# Filter to only week 0
cdystonia_wk0 <- cdystonia %>%
dplyr::filter(week == 0)
tbl <- cdystonia_wk0 |>
tbl_summary(by = treat,
include = c(sex, age,twstrs),
digits=list(all_continuous()~c(0,1)),
type=all_continuous()~"continuous2",
label = list(sex = "Sex",age~"Age (years)",twstrs="TWSTRS total score at baseline"),
statistic = list(
age ~ c(
"{N_obs}",
"{mean} ({sd})",
"{median}",
"{min}, {max}"),
all_categorical() ~ "{n} ({p}%)",
twstrs~"{mean} ({sd})")) |>
add_overall() |>
add_p(pvalue_fun = ~style_sigfig(., digits = 4)) |>
modify_footnote(
all_stat_cols() ~
"BotB = botulinum toxin type B; TWSTRS = Toronto Western Spasmodic Torticollis Rating Scale.",
abbreviation = FALSE
) |>
modify_spanning_header(c(stat_2,stat_3)~"**BotB**")
tbl$table_body$label[tbl$table_body$label == "No. obs."] <- "N"
# making a wide dataset
cdystonia_wide <- cdystonia %>%
pivot_wider(
id_cols = c(id, treat, site, age, sex),
names_from = week,
values_from = twstrs,
names_prefix = "twstrs_"
)
ten_subjects_wide <- cdystonia_wide %>%
head(10)
tbl2 <-
ten_subjects_wide %>%
dplyr::select(id, treat, age, sex, twstrs_2, twstrs_4, twstrs_8, twstrs_12, twstrs_16) %>%
# 1. Create the gtsummary listing object
tbl_listing() %>%
# 2. Modify the column headers using modify_header()
modify_header(
id = "**ID**",
trt = "**Group**",
age = "**Age**",
sexc = "**Sex**",
twstrs_2 = "**Week 2**",
twstrs_4 = "**Week 4**",
twstrs_8 = "**Week 8**",
twstrs_12 = "**Week 12**",
twstrs_16 = "**Week 16**"
) %>%
as_kable_extra(
booktabs = TRUE,
longtable = TRUE,
linesep = "",
caption = "TWSTRS scores for 109 patients with CD at weeks 2, 4, 8, 12, 16"
)
?tbl_summary
#| label: glm-fit
# Fit a GLM
glm_fit <- glm(twstrs ~ week + treat + age + sex,
data = cdystonia,
family = gaussian)
glm_fit |>
tbl_regression()
#kable(tidy(glm_fit), digits=3, caption = "GLM Model Summary (Gaussian Link)")
#| label: glm-fit
# Fit a GLM
glm_fit <- glm(twstrs ~ week + treat + age + sex,
data = cdystonia,
family = gaussian)
glm_fit |>
tbl_regression() |>
as_gt() |>
gt::tab_header(title = "GLM Model Summary (Gaussian Link)")
#kable(tidy(glm_fit), digits=3, caption = "GLM Model Summary (Gaussian Link)")
# Filter to only week 0
cdystonia_wk0 <- cdystonia %>%
dplyr::filter(week == 0)
tbl <- cdystonia_wk0 |>
tbl_summary(by = treat,
include = c(sex, age,twstrs),
digits=all_continuous()~1,
type=all_continuous()~"continuous2",
label = list(sex = "Sex, n(%)",age~"Age (years)",twstrs="TWSTRS total score at baseline"),
statistic = list(
age ~ c(
"{N_obs}",
"{mean} ({sd})",
"{median}",
"{min}, {max}"),
all_categorical() ~ "{n} ({p}%)",
twstrs~"{mean} ({sd})")) |>
add_overall() |>
add_p(pvalue_fun = ~style_sigfig(., digits = 4),
all_continuous()~"oneway.test") |>
modify_footnote(
all_stat_cols() ~
"BotB = botulinum toxin type B; TWSTRS = Toronto Western Spasmodic Torticollis Rating Scale.",
abbreviation = FALSE
) |>
modify_spanning_header(c(stat_2,stat_3)~"**BotB**")
tbl$table_body$label[tbl$table_body$label == "No. obs."] <- "N"
anova1<-aov(twstrs~as.factor(treat),data=cdystonia_wk0)
summary(anova1)
anova1<-aov(twstrs~treat,data=cdystonia_wk0)
summary(anova1)
anova1<-aov(twstrs~treat,data=cdystonia_wk0)
summary(anova1)
?oneway.test
oneway.test(twstrs~treat,data=cdystonia_wk0)
oneway.test(age~treat,data=cdystonia_wk0)
?aov
?oneway.test
oneway.test(age~treat,data=cdystonia_wk0,var.equal=T)
library(ggplot2)
ggplot(cdystonia_wk0, aes(x=treat, y=twstrs)) +
geom_boxplot()
library(ggplot2)
ggplot(cdystonia_wk0, aes(x=treat, y=twstrs)) +
geom_boxplot()
ggplot(cdystonia_wk0, aes(x=treat, y=age)) +
geom_boxplot()
?chisq.test
tab <- table(cdystonia_wk0$sex,cdystonia_wk0$treat)
tab
chisq.test(tab)
library(car)
leveneTest~(age~treat,data=cdystonia_wk0)
leveneTest(age~treat,data=cdystonia_wk0)
?leveneTest
leveneTest(age~treat,data=cdystonia_wk0,center=mean)
leveneTest(twstrs~treat,data=cdystonia_wk0,center=mean)
