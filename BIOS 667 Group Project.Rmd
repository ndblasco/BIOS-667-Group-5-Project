---
title: "BIOS 667 Group 5"
author: 
- Lily Bai
- Nathalie Blasco
- Yihao Peng
- Lauren Rackley
- Sirui Wu
date: "`r Sys.Date()`"
output:
  pdf_document:
    latex_engine: xelatex
    keep_tex: true
bibliography: citations.bib
csl: apa.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
```

```{r,echo=FALSE}
# Load packages
suppressPackageStartupMessages({
library(haven) # for reading in data 
library(tidyverse) # for manipulating data
library(gtsummary) # for making table 1
library(cards)
library(kableExtra)
library(huxtable) # for styling tables
library(gtreg) # for making tables
library(knitr) # for tidying output
library(ggplot2) # for plotting
library(geepack) # for fitting GEE models
})

# Read in data
cdystonia <- read_dta("Data/cdystonia.dta") # mapping to Data folder in GitHub repo

# Inspect data
head(cdystonia)

cdystonia <- cdystonia %>% dplyr::mutate(
    treat = dplyr::case_when(
      treat == 1 ~ "10000 U",
      treat == 2 ~ "5000 U",
      treat == 3 ~ "Placebo"
    ),
    treat = factor(treat, levels = c("Placebo", "5000 U", "10000 U")),
    sex = dplyr::case_when(
      sex == 1 ~ "Female",
      sex == 2 ~ "Male")
    ,
    sex = factor(sex, levels = c("Male", "Female")), # want male as reference group
    site = factor(site, levels = c("1", "2", "3", "4", "5", "6", "7", "8", "9"))) 
```

```{r}
# Filter to only week 0
cdystonia_wk0 <- cdystonia %>%
  dplyr::filter(week == 0)

tbl <- cdystonia_wk0 |>
  tbl_summary(by = treat, 
              include = c(sex, age,twstrs),
              type=all_continuous()~"continuous2",
              label = list(sex = "Sex",age~"Age (years)",twstrs="TWSTRS total score at baseline"),
              statistic = list(
      age ~ c(
      "{N_obs}",
      "{mean} ({sd})",
      "{median}",
      "{min}, {max}"),
      all_categorical() ~ "{n} ({p}%)",
      twstrs~"{mean} ({sd})")) |>
  add_overall() |>
  add_p(pvalue_fun = ~style_sigfig(., digits = 4)) |>
  modify_footnote(
    all_stat_cols() ~ 
      "BotB = botulinum toxin type B; TWSTRS = Toronto Western Spasmodic Torticollis Rating Scale.",
    abbreviation = FALSE
  ) |>
  modify_spanning_header(c(stat_2,stat_3)~"**BotB**")

#show_header_names(tbl)

# making a wide dataset
cdystonia_wide <- cdystonia %>%
  pivot_wider(
    id_cols = c(id, treat, site, age, sex), 
    names_from = week,                     
    values_from = twstrs,              
    names_prefix = "twstrs_"                 
  ) 

ten_subjects_wide <- cdystonia_wide %>% 
  head(10)

tbl2 <-
  ten_subjects_wide %>%
  dplyr::select(id, treat, age, sex, twstrs_2, twstrs_4, twstrs_8, twstrs_12, twstrs_16) %>%
  
  # 1. Create the gtsummary listing object
  tbl_listing() %>%
  
  # 2. Modify the column headers using modify_header()
  modify_header(
    id = "**ID**",
    trt = "**Group**",
    age = "**Age**",
    sexc = "**Sex**",
    twstrs_2 = "**Week 2**",
    twstrs_4 = "**Week 4**",
    twstrs_8 = "**Week 8**",
    twstrs_12 = "**Week 12**",
    twstrs_16 = "**Week 16**"
  ) %>%
  
  # 3. Convert to gt and apply final formatting
  as_gt() %>%
  gt::tab_header(title="Listing 1. TWSTRS scores for 109 patients with CD at weeks 2,4,8,12,16") %>%
  gt::opt_row_striping()
```

## Introduction

The purpose of this project is to examine the effects of botulism toxin type B (BotB) to treat cervical dystonia over time. Cervical dystonia (CD) is a chronic neurological disorder, in which patients have painful involuntary contractions in neck muscles. CD is more prevalent in women [@jankovic_treatment_2023]. The prevalence of CD is estimated to be 28-183 cases per million. The data comes from a multicenter randomized clinical trial for cervical dystonia patients with 9 U.S. sites. Botulism toxin types A and B are first-line treatments for CD [@wetmore_clinical_2025]. The treatment groups included in the study were placebo, 5000 U BotB, and 10000 U BotB. The response variable is Toronto Western Spasmodic Torticollis Rating Scale (TWSTRS) total score, which ranges from 0 to 85 and is comprised of disability (0-30), pain (0-20), and severity (0-35) subscores. Only total score is included in this data.The TWSTRS score was measured at week 0 (baseline), and 2,4,6,8,12, and 16 weeks after treatment start. Site is included in the dataset but no further details about site were included in the available dataset documentation.

## Methods

### *Study Population*

Inclusion and exclusion criteria for the trial were not available. Duration of CD and age at onset were not known. The study included 109 patients (67 (61%)) females.The mean age was 56 (12). Median age was 56 years. The mean TWSTRS score at baseline was 46 (10). It was not known if the patients received prior BotB treatments. Information about the randomization schedule was not provided.

### *Statistical Analyses*

Number of observations, mean, median, standard deviation (SD), minimum (min) and maximum (max) were provided for age. Mean and SD were calculated for TWSTRS score at baseline. Frequencies and percentages were reported for categorical variables. GLM, GLMM, and GEE models were fit using TWSTRS total score as the response variable and blank, blank, blank as covariates.

## Results

```{r,echo=FALSE}
# adding Table 1
as_kable_extra(tbl,
               booktabs=TRUE,
               longtable=TRUE,
               linesep="",
               caption = "Summary of Demographic and Baseline Characteristics",
                table.envir = "table",
               table.attr = "position='h!'")

# adding Table 2
# tbl2

# someone help position these. table 1 should come before table 2
```

### Generalized Linear Model (GLM)

A generalized linear model (GLM model) using a Gaussian link was fit including week, site, treatment, age, and sex as predictors (Table 2).

```{r}
# Fit a GLM
glm_fit <- glm(twstrs ~ week + treat + age + sex + site,
               data = cdystonia,
               family = gaussian)



kable(tidy(glm_fit), digits=3, caption = "GLM Model Summary (Gaussian Link)")
```

The coefficient for week was statistically significant, indicating an overall linear trend in TWSTRS score over time. There was notable variation across study sites, with several sites showing significantly higher TWSTRS scores compared to the reference site, highlighting site-level differences. However, because the GLM assumes independence of observations, the repeated measures within individuals violate this assumption. As a result, the standard errors and p-values may be underestimated, and inference should be interpreted with caution. This motivates the subsequent use of correlation-aware models such as GEE and GLMM.

### GLM Model Diagnostics

Diagnostics were assessed for the GLM model.

```{r}
# Residuals vs Fitted
res <- residuals(glm_fit)
fit <- fitted(glm_fit)

plot(fit, res,
     xlab = "Fitted values",
     ylab = "Residuals",
     main = "Figure 1: Residuals vs Fitted Plot")
abline(h = 0, col = "red", lty = 2, lwd = 2)
```

Figure 1 shows the residuals versus the fitted values. The absence of strong patterns or fanning suggests that the linearity and homoscedasticity assumptions are reasonably met.

```{r}
# Normal Q-Q plot of residuals
qqnorm(res,
       main = "Figure 2: Q-Q Plot",         
       xlab = "Theoretical Quantiles",
       ylab = "Residuals",
       pch = 19,       
       col = "blue")   
qqline(res, col = "red", lwd = 2)

```

Figure 2 presents a QQ plot of the residuals, which largely follow the 45 degree reference line with mild deviations in the tails. This indicates that the normality assumption is approximately satisfied.

```{r}
# Cook's distance
cooks <- cooks.distance(glm_fit)

plot(cooks, type = "h", 
     main = "Figure 3: Cook's Distance Plot", 
     ylab = "Cook's Distance", 
     xlab = "Observation")
abline(h = 4/(length(cooks)-length(coef(glm_fit))), col = "red", lty = 2, lwd = 2)
```

Finally, figure 3 displays Cook's distance for all observations. The conventional threshold, 4/(n-k-1), where n is the number of observations and k is the number of predictors, was used to assess the influence of the observations. Several observations exceeded the threshold and were considered potentially influential and warranted further investigation. Therefore, a second GLM was fit, excluding those observations.

```{r}
# Identify influential points
cooks_d <- cooks.distance(glm_fit)
n <- nrow(cdystonia)
k <- length(coef(glm_fit))
threshold <- 4 / (n - k)
influential_points <- which(cooks_d > threshold)

# Remove influential points
df_no_influential <- cdystonia[-influential_points, ]

# Refit the model using the cleaned data frame
kable(tidy(glm(twstrs ~ week + treat + age + sex + site,
                              data = df_no_influential,
                              family = gaussian())), digits=3, caption = "GLM Model Summary (Excluding Influential Observations)")
```

Excluding influential observations resulted in modest shifts in the parameter estimates and slightly improved precision. Notably, the effect of week remained statistically significant and variation across study sites continued to be pronounced. This underscores that site-level differences remain important even after removing influential observation.s

Overall, excluding influential points slightly adjusted the estimates and improved precision, but the main patterns of association were consistent with the original GLM. As with the previous model, the GLM assumptions are not appropriate for longitudinal data with correlated repeated measures. The following GEE and GLMM analyses address this limitation by explicitly modeling within-subject correlation and random effects.

### Generalized Estimating Equation (GEE)

```{r echo=FALSE, message=FALSE, warning=FALSE}
#Create a new variable represent subject ID - combination of site and ID
data_gee <- cdystonia %>% mutate(
    treat = haven::as_factor(treat),
    sex   = haven::as_factor(sex),
    subj  = interaction(site, id, drop = TRUE)
  )

# Set reference levels
data_gee$treat <- relevel(data_gee$treat, ref = "Placebo")
data_gee$sex <- relevel(data_gee$sex, ref = "Male") # want male as reference group

gee_main <- geeglm(
  twstrs ~ week * treat + age + sex,  # mean model
  id     = subj,                      # cluster = subject
  data   = data_gee,
  family = gaussian,                  # Gaussian working distribution (identity link)
  corstr = "exchangeable"             # working correlation structure
)
#summary(gee_main)
```

A GEE model with Gaussian family, identity link, and an exchangeable correlation structure. The mean model included week, treatment, treatment-by-week interaction, and baseline age and sex, with Placebo as the reference treatment group.

```{r echo=FALSE, message=FALSE, warning=FALSE}
#Residuals
data_gee2 <- data_gee |> mutate(
  pearson = residuals(gee_main, type = "pearson"),
  fitted = predict(gee_main, type = "response")
) 
ggplot(data_gee2, aes(x = fitted, y = pearson, color = treat)) +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = -2, ymax = 2),
            inherit.aes = FALSE, fill = "grey95", alpha = 0.5) +
  geom_point(alpha = 0.6) +
  geom_hline(yintercept = 0, linetype = 2) +
  labs(y = "Pearson residual", x = "Fitted", title = "Figure 4. GEE Model Residuals") +
  theme_minimal()
```

Figure 4 shows Pearson residuals plotted against the fitted TWSTRS values with points colored by treatment group. The residuals are centered around zero and do not show a strong funnel shape, supporting the constant-variance assumption. However, many residuals fall outside $\pm2$, indicating wide individual variation in TWSTRS trajectories and suggesting that the simple Gaussian working model does not fully capture the variance structure. Even so, because the GEE analysis used robust standard errors, the uncertainty in the regression coefficients is driven by the observed variability of the residuals within subjects, rather than depending on the working variance and correlation.

```{r echo=FALSE, message=FALSE, warning=FALSE}
mean_profile <- data_gee %>%
  group_by(treat, week) %>%
  summarise(
    mean_twstrs = mean(twstrs, na.rm = TRUE),
    sd_twstrs   = sd(twstrs, na.rm = TRUE),
    n           = n(),
    se_twstrs   = sd_twstrs / sqrt(n),
    .groups     = "drop"
  )

ggplot(mean_profile, aes(x = week, y = mean_twstrs, colour = treat)) +
  geom_line() +
  geom_point() +
  theme_minimal() +
  labs(
    title = "Figure 5. Mean TWSTRS Over Time by Treatment",
    x     = "Week",
    y     = "Mean TWSTRS",
    colour = "Treatment"
  )
```

Figure 5 shows mean TWSTRS over time by treatment group. All groups show decreases from baseline through weeks 2–4, suggesting early improvement, followed by increases after week 4. Around week 10, both active treatment groups begin to show higher TWSTRS scores than the placebo group.

```{r  echo=FALSE, message=FALSE, warning=FALSE}
tidy(gee_main, effects = "fixed") %>%
  kable(digits = 3, caption = "GEE Model Summary")
```

Table 4 summarizes the GEE estimates for TWSTRS over time by treatment, adjusted for age and sex. The main effects for treat5000U (−0.810, p = 0.769) and treat10000U (−2.738, p = 0.248) compare baseline TWSTRS at week 0 with placebo. Both estimates are negative but not statistically significant, indicating no clear baseline differences in mean TWSTRS between treatment groups and placebo. The treatment-by-week interaction terms describe how each treatment's trajectory differs from placebo over time. For 5000U, the additional slope relative to placebo is small and not significant (0.115, p = 0.388), suggesting that its average linear trend over time is similar to placebo. For 10000U, the additional slope is larger and statistically significant (0.323, p = 0.027), indicating an average increase in TWSTRS over 16 weeks compared with placebo. Because higher TWSTRS scores reflect worse symptoms, these results imply that low-dose regimen behaves similarly to placebo, while the high-dose regimen is associated with faster worsening over time. Overall, the GEE model provides a reasonable approach for assessing whether treatment affects population-average TWSTRS trajectories over time, while recognizing that the true time course is somewhat non-linear and that estimated treatment effects are relatively small.


## Discussion

Summarization of main points, conclusions based in results Summarization of the various models applied, which ones you prefer and base your interpretations off of and why Discussion of limitations if any

## References

